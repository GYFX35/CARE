{% extends "base.html" %}

{% block content %}
    <h1>{{ _('User: %(username)s', username=user.username) }}</h1>
    <img src="{{ user.profile_picture or url_for('static', filename='default_avatar.png') }}" alt="Profile Picture" width="128" height="128">

    {% if user == current_user %}
    <button id="change-picture-btn">Change Profile Picture</button>
    <div id="camera-container" style="display: none;">
        <video id="camera-stream" width="320" height="240" autoplay></video>
        <button id="capture-btn">Capture</button>
        <canvas id="canvas" width="320" height="240" style="display: none;"></canvas>
    </div>

    <script>
        const changePictureBtn = document.getElementById('change-picture-btn');
        const cameraContainer = document.getElementById('camera-container');
        const cameraStream = document.getElementById('camera-stream');
        const captureBtn = document.getElementById('capture-btn');
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');

        changePictureBtn.addEventListener('click', function() {
            cameraContainer.style.display = 'block';
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(function(stream) {
                    cameraStream.srcObject = stream;
                })
                .catch(function(err) {
                    console.error("Error accessing camera: ", err);
                });
        });

        captureBtn.addEventListener('click', function() {
            context.drawImage(cameraStream, 0, 0, 320, 240);
            const dataURL = canvas.toDataURL('image/png');
            fetch('{{ url_for('upload_profile_picture') }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ image: dataURL })
            }).then(function(response) {
                if (response.ok) {
                    window.location.reload();
                }
            });
        });
    </script>
    {% endif %}
    <p><a href="{{ url_for('send_message', recipient=user.username) }}">{{ _('Send private message') }}</a></p>
    <hr>
    {% for post in posts %}
    <article>
        <h4>{{ post.title }}</h4>
        <p>{{ post.content }}</p>
    </article>
    {% endfor %}
{% endblock %}
